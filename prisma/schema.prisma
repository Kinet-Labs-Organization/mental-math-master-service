generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Authentication and authorization related enums
enum SignUpMethod {
  EMAIL
  GOOGLE
  FACEBOOK
  APPLE
}

enum Role {
  SYSTEM
  ADMIN
  OWNER
  MANAGER
  STAFF
}

enum OrderStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
  REFUNDED
}

// Vendor or Business or Company details
model Vendor {
  id       String  @id @default(uuid())
  isActive Boolean @default(true)
  name     String
  vendorId String  @unique

  // Relationships
  products   Product[]
  orders     Order[]
  customers  Customer[]
  vendorUser VendorUser[]

  // Audit fields
  createdAt     DateTime @default(now())
  createdBy     String   @default("SYSTEM")
  lastUpdatedAt DateTime @updatedAt
  lastUpdatedBy String   @default("SYSTEM")

  @@map("vendor")
}

// Vendor or Business or Company owner and their staff members
model VendorUser {
  id           String       @id @default(uuid())
  email        String
  password     String
  name         String
  phone        String?
  signUpMethod SignUpMethod
  role         Role
  isActive     Boolean      @default(true)

  // Relationships
  vendorId String
  vendor   Vendor @relation(fields: [vendorId], references: [id])

  // Audit fields
  createdAt     DateTime @default(now())
  createdBy     String   @default("SYSTEM")
  lastUpdatedAt DateTime @updatedAt
  lastUpdatedBy String   @default("SYSTEM")

  @@map("vendor_user")
}

// End customers/buyers
model Customer {
  id      String @id @default(uuid())
  email   String @unique
  name    String
  phone   String @unique
  address Json? // Structured address data

  // Relationships
  orders Order[] // Optional reference from orders

  // Multi-tenant relationship
  vendorId String
  vendor   Vendor @relation(fields: [vendorId], references: [id])

  // Audit fields
  createdAt     DateTime @default(now())
  createdBy     String   @default("SYSTEM")
  lastUpdatedAt DateTime @updatedAt
  lastUpdatedBy String   @default("SYSTEM")

  @@index([email])
  @@map("customers")
}

// Products/inventory items
model Product {
  id          String  @id @default(uuid())
  sku         String?
  name        String
  description String?
  price       Decimal @db.Decimal(10, 2)
  quantity    Int     @default(0)
  isActive    Boolean @default(true)

  // Multi-tenant relationship
  vendorId String
  vendor   Vendor @relation(fields: [vendorId], references: [id])

  // Flexible relationship with orders through OrderItem
  orderItems OrderItem[]

  // Audit fields
  createdAt     DateTime @default(now())
  createdBy     String   @default("SYSTEM")
  lastUpdatedAt DateTime @updatedAt
  lastUpdatedBy String   @default("SYSTEM")

  @@map("products")
}

// Intermediary model for Order-Product relationship
model OrderItem {
  id String @id @default(uuid())

  // Product reference (optional)
  productId String?
  product   Product? @relation(fields: [productId], references: [id])

  // Order reference
  orderId String
  order   Order  @relation(fields: [orderId], references: [id])

  // Denormalized product data
  productSnapshot Json // Stores name, sku, price at time of order
  quantity        Int
  unitPrice       Decimal @db.Decimal(10, 2)
  totalPrice      Decimal @db.Decimal(10, 2)

  // Audit fields
  createdAt     DateTime @default(now())
  createdBy     String   @default("SYSTEM")
  lastUpdatedAt DateTime @updatedAt
  lastUpdatedBy String   @default("SYSTEM")

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// Orders
model Order {
  id          String      @id @default(uuid())
  orderNumber String      @unique @default(uuid())
  status      OrderStatus @default(PENDING)

  // Flexible customer relationship
  userId      String? // Optional reference to registered user
  user        Customer? @relation(fields: [userId], references: [id])
  userDetails Json // Snapshot of user details at time of order

  // Order details
  orderItems  OrderItem[]
  totalAmount Decimal     @db.Decimal(10, 2)
  orderNote   String?

  // Multi-tenant relationship
  vendorId String
  vendor   Vendor @relation(fields: [vendorId], references: [id])

  // Audit fields
  createdAt     DateTime @default(now())
  createdBy     String   @default("SYSTEM")
  lastUpdatedAt DateTime @updatedAt
  lastUpdatedBy String   @default("SYSTEM")

  @@index([orderNumber])
  @@index([userId])
  @@index([vendorId])
  @@index([status])
  @@map("orders")
}
