// This is a production-ready schema for an e-commerce application
// It implements flexible relationships between Orders, Products, and Users
// with proper audit trails and multi-tenant support

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Authentication and authorization related enums
enum SignUpMethod {
  EMAIL
  GOOGLE
  FACEBOOK
  APPLE
}

enum Role {
  ADMIN
  VENDOR
  MANAGER
  STAFF
}

enum OrderStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
  REFUNDED
}

// Vendor/Business owner and their staff members
model Vendor {
  id           String       @id @default(uuid())
  email        String
  password     String
  name         String
  companyName  String
  companyId    String       @unique @default(uuid())
  phone        String?
  signUpMethod SignUpMethod
  role         Role
  isActive     Boolean      @default(true)

  // Relationships
  products Product[]
  orders   Order[]
  users    User[]

  // Audit fields
  createdAt     DateTime @default(now())
  createdBy     String   @default("system")
  lastUpdatedAt DateTime @updatedAt
  lastUpdatedBy String   @default("system")

  @@index([email])
  @@map("vendor_users")
}

// End customers/buyers
model User {
  id      String  @id @default(uuid())
  email   String  @unique
  name    String
  phone   String?
  address Json? // Structured address data

  // Relationships
  orders Order[] // Optional reference from orders

  // Multi-tenant relationship
  vendorId String
  vendor   Vendor @relation(fields: [vendorId], references: [id])

  // Audit fields
  createdAt     DateTime @default(now())
  createdBy     String   @default("system")
  lastUpdatedAt DateTime @updatedAt
  lastUpdatedBy String   @default("system")

  @@index([email])
  @@map("users")
}

// Products/inventory items
model Product {
  id          String  @id @default(uuid())
  sku         String  @unique
  name        String
  description String?
  price       Decimal @db.Decimal(10, 2)

  // Multi-tenant relationship
  vendorId String
  vendor   Vendor @relation(fields: [vendorId], references: [id])

  // Flexible relationship with orders through OrderItem
  orderItems OrderItem[]

  // Audit fields
  createdAt     DateTime @default(now())
  createdBy     String   @default("system")
  lastUpdatedAt DateTime @updatedAt
  lastUpdatedBy String   @default("system")

  @@index([sku])
  @@index([vendorId])
  @@map("products")
}

// Intermediary model for Order-Product relationship
model OrderItem {
  id String @id @default(uuid())

  // Product reference (optional)
  productId String?
  product   Product? @relation(fields: [productId], references: [id])

  // Order reference
  orderId String
  order   Order  @relation(fields: [orderId], references: [id])

  // Denormalized product data
  productSnapshot Json // Stores name, sku, price at time of order
  quantity        Int
  unitPrice       Decimal @db.Decimal(10, 2)
  totalPrice      Decimal @db.Decimal(10, 2)

  // Audit fields
  createdAt     DateTime @default(now())
  createdBy     String   @default("system")
  lastUpdatedAt DateTime @updatedAt
  lastUpdatedBy String   @default("system")

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// Orders
model Order {
  id          String      @id @default(uuid())
  orderNumber String      @unique @default(uuid())
  status      OrderStatus @default(PENDING)

  // Flexible customer relationship
  userId      String? // Optional reference to registered user
  user        User?   @relation(fields: [userId], references: [id])
  userDetails Json // Snapshot of user details at time of order

  // Order details
  orderItems  OrderItem[]
  totalAmount Decimal     @db.Decimal(10, 2)
  orderNote   String?

  // Multi-tenant relationship
  vendorId String
  vendor   Vendor @relation(fields: [vendorId], references: [id])

  // Audit fields
  createdAt     DateTime @default(now())
  createdBy     String   @default("system")
  lastUpdatedAt DateTime @updatedAt
  lastUpdatedBy String   @default("system")

  @@index([orderNumber])
  @@index([userId])
  @@index([vendorId])
  @@index([status])
  @@map("orders")
}
